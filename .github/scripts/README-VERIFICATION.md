# Discord Health Verification System

**Created:** 2026-01-23
**Purpose:** Automated verification that Discord channels are healthy and jobs are posting correctly

## Overview

This verification system provides automated health monitoring for the Discord job posting infrastructure across all three job board repositories (New-Grad, Internships, Remote-Jobs).

### What It Checks

1. **Channel Health** - All expected Discord channels exist and are accessible
2. **Message Activity** - Channels are receiving job posts (not stale)
3. **Job Distribution** - Multi-channel routing is working correctly
4. **Workflow Health** - GitHub Actions workflows are completing successfully

### Components

```
.github/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ verify-discord-channels.js      # Channel health check
‚îÇ   ‚îú‚îÄ‚îÄ verify-job-distribution.js      # Job routing analysis
‚îÇ   ‚îú‚îÄ‚îÄ verify-workflow-health.js       # Workflow success monitoring
‚îÇ   ‚îî‚îÄ‚îÄ README-VERIFICATION.md          # This file
‚îî‚îÄ‚îÄ workflows/
    ‚îî‚îÄ‚îÄ verify-discord-health.yml        # Automated daily verification
```

---

## Scripts

### 1. verify-discord-channels.js

**Purpose:** Verify all Discord channels exist and check recent message activity

**Usage:**
```bash
# Basic usage (checks last 24 hours)
node .github/scripts/verify-discord-channels.js

# Required environment variables
export DISCORD_TOKEN="your-bot-token"
export DISCORD_GUILD_ID="your-server-id"
export BOARD_TYPE="new-grad"  # or "internships" or "remote"

# Plus all channel ID environment variables (see board-types.js)
```

**What It Checks:**
- ‚úÖ All expected channels exist (from board-types.js config)
- ‚úÖ Channels are accessible by the bot
- ‚úÖ Message count in last 24 hours per channel
- ‚ö†Ô∏è Warns if channels have no activity
- üö® Fails if channels are missing

**Output Example:**
```
üìä Summary:
  Expected Channels: 9
  Found & Accessible: 9
  Missing: 0
  Active (24h): 7
  Inactive: 2

‚úÖ Active Channels (24h)
  ‚úì tech (industry)
     Discord Name: tech-jobs
     Messages: 145

‚ö†Ô∏è  WARNING: Channels with No Activity (24h)
  ‚ö° finance (industry)
     Discord Name: finance-jobs
     Messages: 0
```

**Exit Codes:**
- `0` - All checks passed
- `1` - Critical issues (missing channels)

---

### 2. verify-job-distribution.js

**Purpose:** Analyze job posting logs to verify multi-channel routing is working

**Usage:**
```bash
# Analyze last 7 days
node .github/scripts/verify-job-distribution.js --days=7

# Analyze last 30 days with verbose output
node .github/scripts/verify-job-distribution.js --days=30 --verbose

# Required environment variable
export BOARD_TYPE="new-grad"  # or "internships" or "remote"
```

**What It Checks:**
- ‚úÖ Jobs are being posted (not all filtered out)
- ‚úÖ Multi-channel routing is working (jobs ‚Üí multiple channels)
- ‚úÖ Success rate is acceptable (>90%)
- ‚úÖ Channel distribution looks normal
- ‚ö†Ô∏è Warns if <20% of jobs go to multiple channels
- üö® Fails if >10% failure rate

**Data Sources:**
- `.github/data/metrics/discord-*.jsonl` - Discord posting logs
- Generated by `discord-post-logger.js` and `routing-logger.js`

**Output Example:**
```
üìä Summary:
   Total Events: 1,234
   Unique Jobs: 456
   Successful Posts: 890
   Failed Posts: 12
   Skipped Posts: 332

üîÄ Multi-Channel Routing:
   Jobs Posted to Multiple Channels: 234
   Multi-Channel Rate: 51.3%

üìç Channel Distribution:
   tech              :  345 ( 38.8%) ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
   bay-area          :  156 ( 17.5%) ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
   ai                :   89 ( 10.0%) ‚ñà‚ñà‚ñà‚ñà
```

**Exit Codes:**
- `0` - Distribution healthy
- `1` - Critical issues (high failure rate, low activity)

---

### 3. verify-workflow-health.js

**Purpose:** Check GitHub Actions workflow run history via GitHub API

**Usage:**
```bash
# Analyze last 10 workflow runs
node .github/scripts/verify-workflow-health.js --runs=10

# Analyze last 20 runs
node .github/scripts/verify-workflow-health.js --runs=20

# Required environment variables
export GITHUB_TOKEN="ghp_xxxxx"  # Optional, increases API rate limit
export GITHUB_REPOSITORY="zapplyjobs/New-Grad-Jobs-2026"
```

**What It Checks:**
- ‚úÖ Workflow runs are succeeding
- ‚úÖ Jobs are being posted (not skipped)
- ‚úÖ No consecutive failures
- ‚ö†Ô∏è Warns if >30% failure rate
- üö® Fails if 3+ consecutive failures

**API Access:**
- Uses GitHub REST API to fetch workflow runs
- Analyzes workflow steps to detect job posting activity
- No authentication required (but recommended for higher rate limits)

**Output Example:**
```
üìä Summary (Last 10 Runs):
   Successful Runs: 9
   Failed Runs: 1
   Failure Rate: 10.0%
   Consecutive Failures: 0

üì§ Job Posting Activity:
   Runs with Jobs Posted: 8
   Job Posting Rate: 80.0%

üìã Recent Workflow Runs:
   ‚úÖ Run #1234 (1/23/2026)
      Status: success
      üì§ Jobs Posted
```

**Exit Codes:**
- `0` - Workflow health good
- `1` - Critical issues detected

---

## GitHub Actions Workflow

### verify-discord-health.yml

**Schedule:** Runs daily at 1 AM UTC (after job posting workflows complete)

**Triggers:**
- Scheduled (daily at 1 AM UTC)
- Manual via `workflow_dispatch`

**What It Does:**

1. **Run All 3 Verification Scripts**
   - Channel health check
   - Job distribution analysis
   - Workflow health check

2. **Generate Summary Report**
   - Combines all verification results
   - Determines overall health status

3. **Post to GitHub Issue**
   - Creates or updates a `health-monitoring` issue
   - Posts results as issue comment
   - Provides centralized monitoring dashboard

4. **Upload Artifacts**
   - Saves detailed logs as workflow artifacts
   - Retention: 30 days

5. **Fail if Critical Issues**
   - Fails the workflow if any verification fails
   - Sends GitHub Actions notification

**Permissions Required:**
- `contents: read` - To checkout repository
- `issues: write` - To post to monitoring issue

**Manual Trigger:**
```bash
# Via GitHub CLI
gh workflow run verify-discord-health.yml

# Via GitHub UI
Actions ‚Üí Discord Health Verification ‚Üí Run workflow
```

---

## Monitoring Dashboard

After the first run, the workflow creates a GitHub Issue titled:
- **New-Grad:** "üìä Discord Health Monitoring"
- **Internships:** "üìä Discord Health Monitoring (Internships)"
- **Remote-Jobs:** "üìä Discord Health Monitoring (Remote Jobs)"

This issue serves as a centralized dashboard for all verification results.

**Access:**
- Go to repository Issues tab
- Filter by label: `health-monitoring`
- Each daily run posts a new comment with results

**What You'll See:**
- ‚úÖ Green checkmarks for passing checks
- ‚ö†Ô∏è Yellow warnings for degraded performance
- ‚ùå Red X for critical failures
- Detailed logs for each verification script

---

## Troubleshooting

### Channel Verification Fails

**Error:** "Missing channels detected"

**Causes:**
- Channel was deleted in Discord
- Environment variable not set in GitHub Secrets
- Bot doesn't have access to channel

**Fix:**
1. Check Discord server - does channel exist?
2. Check GitHub Secrets - is `DISCORD_XXX_CHANNEL_ID` set?
3. Check bot permissions - can it see the channel?

### Job Distribution Issues

**Warning:** "Low multi-channel routing: 5.2%"

**Causes:**
- Multi-channel mode not enabled (check GitHub Secrets)
- Industry/location routing broken
- All jobs going to single channel

**Fix:**
1. Check `MULTI_CHANNEL_MODE=true` in GitHub Secrets
2. Verify industry channel secrets are set
3. Check `routing-logger.js` output for routing decisions

**Warning:** "High failure rate: 15.3%"

**Causes:**
- Discord API rate limiting
- Invalid URLs in job data
- Bot token expired

**Fix:**
1. Check Discord API rate limit headers
2. Review failed jobs in logs for common patterns
3. Verify `DISCORD_TOKEN` is valid

### Workflow Health Issues

**Error:** "3 consecutive failures"

**Causes:**
- Discord bot code has a bug
- Job fetcher failing
- GitHub Actions infrastructure issue

**Fix:**
1. Check latest workflow run logs
2. Review error messages in failed steps
3. Test bot locally with `node .github/scripts/enhanced-discord-bot.js`

### Low Activity Warning

**Warning:** "Low activity: 2.3 jobs/day"

**Causes:**
- Normal variation (weekends, holidays)
- Job fetcher not finding new jobs
- All jobs being filtered out

**Expected:**
- Weekends: 50-70% of weekday volume
- Holidays: Near zero activity
- Weekdays: 5-50 jobs/day (varies by board)

**When to Investigate:**
- Multiple consecutive days of zero jobs
- Sudden drop >80% from normal levels
- All jobs filtered out (check filter logic)

---

## Thresholds & Tuning

Default thresholds in verification scripts:

### Channel Health
```javascript
const HOURS_TO_CHECK = 24;           // Check last 24 hours
const MIN_MESSAGES_WARNING = 1;      // Warn if <1 message in 24h
const MIN_MESSAGES_CRITICAL = 0;     // Fail if channel missing
```

### Job Distribution
```javascript
const MIN_JOBS_PER_DAY = 5;          // Alert if <5 jobs/day
const MAX_FAILURE_RATE = 0.1;        // Alert if >10% failure rate
const MIN_MULTI_CHANNEL_RATE = 0.2;  // Alert if <20% multi-channel
```

### Workflow Health
```javascript
const MAX_FAILURE_RATE = 0.3;              // Alert if >30% failure rate
const MIN_JOBS_POSTED_RATE = 0.5;          // Alert if <50% posted jobs
const CRITICAL_CONSECUTIVE_FAILURES = 3;   // Alert if 3+ consecutive
```

**To Customize:**
Edit the constants at the top of each script and commit changes.

---

## Integration with Existing Systems

### Works With

1. **Discord Post Logger** (`.github/scripts/discord-post-logger.js`)
   - Generates logs that `verify-job-distribution.js` analyzes
   - JSONL format in `.github/data/metrics/discord-*.jsonl`

2. **Routing Logger** (`.github/scripts/routing-logger.js`)
   - Tracks multi-channel routing decisions
   - Used by distribution verification

3. **Board Types System** (`.github/scripts/src/board-types.js`)
   - Defines expected channels per board type
   - Used by channel verification to know what to check

4. **Enhanced Discord Bot** (`.github/scripts/enhanced-discord-bot.js`)
   - Main posting system that generates logs
   - Verification system validates its output

### Data Flow

```
Job Fetcher
    ‚Üì
Enhanced Discord Bot (posts jobs)
    ‚Üì
Discord Post Logger (logs results)
    ‚Üì
Metrics JSONL Files
    ‚Üì
Verification Scripts (daily analysis)
    ‚Üì
GitHub Issue (monitoring dashboard)
```

---

## Multi-Repository Deployment

This verification system is deployed to all 3 repositories:

1. **New-Grad-Jobs-2026**
   - Board Type: `new-grad`
   - Channels: 9 (4 industry + 5 location)
   - Channel Mode: Environment variables

2. **Internships-2026**
   - Board Type: `internships`
   - Channels: 27 (11 industry + 15 location + 1 category)
   - Channel Mode: Environment variables

3. **Remote-Jobs-2026**
   - Board Type: `remote`
   - Posts to: New-Grad Discord server
   - Channels: 2 (remote-jobs + remote-usa-jobs)
   - Channel Mode: Discovery (no env vars needed)

**Maintenance:**
- Changes to verification logic should be synced across all 3 repos
- Each repo has independent GitHub Secrets configuration
- Workflows run independently (separate monitoring issues)

---

## Future Enhancements

Possible improvements to consider:

1. **Historical Trend Analysis**
   - Track metrics over time
   - Alert on anomalies (sudden spikes/drops)
   - Generate weekly/monthly reports

2. **Alerting Integration**
   - Slack/Discord notifications for failures
   - Email alerts for critical issues
   - PagerDuty integration for on-call

3. **Performance Metrics**
   - Posting latency tracking
   - Rate limit monitoring
   - Job fetch performance

4. **Auto-Remediation**
   - Automatically retry failed posts
   - Restart stuck workflows
   - Clear rate limit backlogs

5. **Cross-Repository Insights**
   - Compare health across all 3 boards
   - Unified dashboard for all repositories
   - Correlation analysis

---

## Claude Metrics System

**Created:** 2026-01-23
**Purpose:** Optimized metrics for Claude to easily debug and track job posting activity

### Overview

The metrics system aggregates job posting data from multiple sources into a comprehensive JSON report that's committed to git, making it always available for Claude to analyze.

### Quick Start for Claude

**1. Query Latest Metrics:**
```bash
node .github/scripts/query-metrics.js --summary
```

**2. View Channel Distribution:**
```bash
node .github/scripts/query-metrics.js --channels
```

**3. Find Specific Job:**
```bash
node .github/scripts/query-metrics.js --job=<job-id>
```

**4. Check Failures:**
```bash
node .github/scripts/query-metrics.js --failures
```

### Components

```
.github/
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ metrics/
‚îÇ       ‚îú‚îÄ‚îÄ latest.json              # Always current (committed to git)
‚îÇ       ‚îî‚îÄ‚îÄ YYYY-MM-DD.json          # Daily snapshots (7-day retention)
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ generate-metrics-report.js   # Aggregates metrics
    ‚îî‚îÄ‚îÄ query-metrics.js             # Query tool for Claude
```

### Metrics Report Structure

The `latest.json` file contains:

**Summary Statistics:**
- Total jobs posted
- Unique jobs
- Multi-channel postings
- Failed postings
- Filtered jobs
- Active channels

**Per-Channel Data:**
- Job count per channel
- List of job IDs posted to each channel
- Recent job details (last 10)

**Multi-Channel Routing:**
- Jobs posted to multiple channels
- Which channels each job was posted to
- Timestamp and job details

**Failures:**
- Jobs that failed to post
- Error messages and codes
- Channel and timestamp

**Filtered Jobs:**
- Blacklisted jobs
- Already posted (duplicates)
- Invalid data
- Other reasons

### Common Debugging Scenarios

**Scenario 1: "Did job X get posted?"**
```bash
node .github/scripts/query-metrics.js --job=jobs-smartrecruiters-com-google-12345
```

Output shows:
- Which channel(s) it was posted to
- When it was posted
- Or why it failed/was filtered

**Scenario 2: "How many jobs went to tech-jobs channel?"**
```bash
node .github/scripts/query-metrics.js --channel=tech-jobs
```

Output shows:
- Total post count
- Unique job count
- Recent job listings

**Scenario 3: "What jobs were posted to multiple channels?"**
```bash
node .github/scripts/query-metrics.js --multi-channel
```

Output shows:
- Jobs routed to 2+ channels
- Which channels each went to
- Grouped by channel count

**Scenario 4: "What's failing and why?"**
```bash
node .github/scripts/query-metrics.js --failures
```

Output shows:
- Grouped by error type
- Job details for each failure
- Timestamps

**Scenario 5: "Why aren't jobs posting?"**
```bash
node .github/scripts/query-metrics.js --filtered
```

Output shows:
- Breakdown by filter reason
- Blacklisted jobs
- Duplicates
- Invalid data

**Scenario 6: "What happened in the last 24 hours?"**
```bash
node .github/scripts/query-metrics.js --multi-channel --last-24h
node .github/scripts/query-metrics.js --failures --last-24h
```

Filters all results to last 24 hours only.

### Data Sources

The metrics aggregator pulls from:

1. **posted_jobs.json** - Database of all posted jobs
   - Location: `.github/data/posted_jobs.json`
   - Contains job metadata and Discord thread IDs

2. **Discord Posting Logs** - Recent posting activity
   - Location: `.github/logs/discord-posts-YYYY-MM-DD.jsonl`
   - Generated by `discord-post-logger.js`
   - Contains success/failure/skip for each posting attempt

3. **Routing Logs** - Channel routing decisions
   - Location: `.github/audit/routing-encrypted.json`
   - Generated by `routing-logger.js`
   - Shows which job went to which channel and why

### Automated Updates

Metrics are automatically regenerated after every job posting run:

1. **Workflow runs** (every 15 minutes)
2. **Bot posts jobs** to Discord
3. **Loggers capture results** (discord-post-logger.js)
4. **Metrics aggregator runs** (generate-metrics-report.js)
5. **latest.json updated** and committed to git

This means Claude can always read the latest metrics from git without needing to run any scripts.

### Query Commands Reference

```bash
# Show summary
node .github/scripts/query-metrics.js --summary

# Show all channels
node .github/scripts/query-metrics.js --channels

# Show specific channel
node .github/scripts/query-metrics.js --channel=tech-jobs

# Show multi-channel routing
node .github/scripts/query-metrics.js --multi-channel

# Show failures
node .github/scripts/query-metrics.js --failures

# Show filtered jobs
node .github/scripts/query-metrics.js --filtered

# Find specific job
node .github/scripts/query-metrics.js --job=<job-id>

# Filter to last 24 hours
node .github/scripts/query-metrics.js --multi-channel --last-24h

# Get raw JSON
node .github/scripts/query-metrics.js --json

# Verbose output
node .github/scripts/query-metrics.js --channels --verbose
```

### Reading Metrics Directly

Claude can also read `latest.json` directly:

```bash
# Read metrics file
cat .github/data/metrics/latest.json

# Or use jq for filtering
cat .github/data/metrics/latest.json | jq '.summary'
cat .github/data/metrics/latest.json | jq '.by_channel["tech-jobs"]'
cat .github/data/metrics/latest.json | jq '.failures'
```

### Metrics Retention

- **latest.json** - Always current, committed to git
- **YYYY-MM-DD.json** - Daily snapshots, 7-day retention
- **Older metrics** - Automatically deleted after 7 days

### Troubleshooting

**Issue: "Metrics not found"**

Solution:
```bash
# Generate metrics manually
node .github/scripts/generate-metrics-report.js --days=7
```

**Issue: "Job not found in metrics"**

Possible causes:
- Job is older than 7 days (outside metrics period)
- Job was never posted (check if it exists in new_jobs.json)
- Job ID is incorrect

**Issue: "Channel data missing"**

Possible causes:
- Channel received no jobs in last 7 days
- Channel ID not in environment variables
- Logs are missing

### Advanced Usage

**Generate metrics for custom period:**
```bash
# Last 30 days
node .github/scripts/generate-metrics-report.js --days=30

# Last 24 hours
node .github/scripts/generate-metrics-report.js --days=1
```

**Compare dated snapshots:**
```bash
# View metrics from 3 days ago
cat .github/data/metrics/2026-01-20.json | jq '.summary'

# Compare with today
cat .github/data/metrics/latest.json | jq '.summary'
```

### Integration with Other Tools

The metrics system works alongside:

- **discord-post-logger.js** - Generates posting logs
- **routing-logger.js** - Tracks routing decisions
- **verify-job-distribution.js** - Uses metrics for health checks
- **channel-stats.js** - Collects channel statistics

All tools feed data into the metrics aggregator for unified reporting.

---

## Support

**Issues:** Create a GitHub issue with the `health-monitoring` label

**Logs:** Download workflow artifacts for detailed debugging

**Contact:** Check repository maintainers

---

**Last Updated:** 2026-01-23
**Version:** 1.1.0
**Maintainer:** Automated via GitHub Actions
